<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mood Booster</title>

    <style>
      :root{
        --pink:#ff69b4;
        --hotpink:#ff1493;
        --bg:#ffe4e1;
        --card-bg:#ffffff;
        --muted:#f0f0f0;
        --text:#111;
      }
      [data-theme="dark"]{
        --bg:#1b1220;
        --card-bg:#241726;
        --muted:#2b1c2a;
        --pink:#ff9acb;
        --hotpink:#ff6ea6;
        --text:#f6eef6;
      }
      html,body{height:100%}
      body {
          background-color: var(--bg);
          color: var(--text);
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          margin: 0;
          font-family: "Poppins";
          text-align: center;
          overflow: auto;
          transition: background-color .25s, color .25s;
      }

      #themeToggle {
        position: fixed;
        right: 12px;
        top: 12px;
        background: transparent;
        border: 2px solid rgba(255,255,255,0.12);
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        z-index: 99999;
        font-weight:700;
        backdrop-filter: blur(4px);
      }

      .container {
          background-color: var(--card-bg);
          padding: 28px 32px;
          border-radius: 18px;
          box-shadow: 0 12px 30px rgba(0,0,0,0.08);
          width: 720px;
          max-width: calc(100% - 40px);
          display: flex;
          gap: 28px;
          align-items: center;
          justify-content: center;
          transition: background-color .25s, box-shadow .25s;
      }

      .left-col {
          width: 560px;
          display:flex;
          flex-direction:column;
          align-items:center;
          gap:14px;
      }

      h1{font-size:1.6rem;margin:0 0 4px;font-weight:700;color:var(--text)}
      .avatar-wrap{
          width:170px;height:170px;border-radius:50%;
          padding:6px;border:6px solid var(--pink);
          display:flex;align-items:center;justify-content:center;
      }

      #pet-display {
          width:150px;
          height:150px;
          border-radius:50%;
          object-fit:cover;
          transition: transform .25s, border-color .25s;
      }

      .meter{ width:100%; background:var(--muted); border-radius:12px; padding:4px; }
      .progress{
          height:26px; width:50%;
          background:linear-gradient(90deg,var(--hotpink),var(--pink));
          border-radius:10px;
          display:flex;align-items:center;justify-content:center;
          color:#fff;font-weight:700;
          transition: width 0.45s ease-in-out;
      }

      #status-message{ color:var(--pink); font-weight:600; margin-top:6px; }
      #last-interaction { font-size:12px; opacity:0.7; margin-top:4px; }

      .buttons{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:4px; }
      .buttons button{
          padding:10px 16px; border-radius:10px; border:none;
          background:var(--pink); color:#fff;
          font-weight:600; cursor:pointer;
      }
      .action-big { width:160px; }
    </style>
</head>
<body>

<script>
  (function(){
    try {
      const TOKEN_KEY = 'mood_booster_auth_v1';
      const DEFAULT_EXPIRY_MS = 1000*60*60*24*7;
      function isTokenValid(raw){
        if(!raw) return false;
        const p = raw.split(':');
        if(p[0] !== 'ok') return false;
        if(p[2] === 'perm') return true;
        return (Date.now() - parseInt(p[1])) < DEFAULT_EXPIRY_MS;
      }
      const t = localStorage.getItem(TOKEN_KEY);
      if(!isTokenValid(t)){
        localStorage.removeItem(TOKEN_KEY);
        location.replace('gate.html');
      }
    }catch(e){ location.replace('gate.html'); }
  })();
</script>

<button id="themeToggle">üåô</button>

<div class="container">
  <div class="left-col">
    <h1>Hi B (B for Brader)</h1>

    <div class="avatar-wrap">
      <img id="pet-display" src="ratna_normal.png">
    </div>

    <div class="meter">
      <div id="health-bar" class="progress">Kesihatan</div>
    </div>

    <div id="status-message">Hai Anep!</div>
    <div id="last-interaction">Last: -</div>

    <div class="buttons">
      <button onclick="feedPet()">Beri Makan üçî</button>
      <button onclick="petPet()">Pujuk ü§ó</button>
      <button onclick="sendKiss()" class="action-big">Send Kiss üòò</button>
    </div>
  </div>
</div>

<canvas id="confettiCanvas" style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></canvas>

<script>
let health = 100;
const petDisplay = document.getElementById('pet-display');
const statusMessage = document.getElementById('status-message');
const healthBar = document.getElementById('health-bar');

function changeImage(img){ petDisplay.src = img; }

function updatePetStatus(msg){
  statusMessage.textContent = msg;
  healthBar.style.width = health+"%";
  healthBar.textContent = health+"% Mood Titew";
}

function feedPet(){
  health = Math.min(100, health+15);
  updatePetStatus("Yummy! Masyeh Anep! üòã");
  changeImage("ratna_makan.png");
}

function petPet(){
  health = Math.min(100, health+10);
  updatePetStatus("Ocey, Tak Majuk Dah! ü•∞");
  changeImage("ratna_gembira.png");
}

function sendKiss(){
  health = Math.min(100, health+5);
  updatePetStatus("Muaahh! üíñ");
  changeImage("ratna_kiss.png");
}

setInterval(()=>{
  health = Math.max(0, health-2);
  if(health === 0){
    updatePetStatus("Oh No! Anep Dah Tak Sayang Saya! üíÄ");
    changeImage("ratna_normal.png");
  }else{
    updatePetStatus("Nak attention pwiss! ü•∫");
    changeImage("ratna_normal.png");
  }
},3000);

updatePetStatus("Hai Anep! Jaga Titew baik-baik ya! üòä");
</script>

<script>
// deviceId
(function(){
  const KEY = 'pet_deviceId';
  let id = localStorage.getItem(KEY);
  if(!id){
    id = "dev-" + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
    localStorage.setItem(KEY,id);
  }
  window.deviceId = id;
})();
</script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDH0xKiNZ_f2opGL18pbZ-7xLt9pTS-9k8",
    authDomain: "anep-s-booster.firebaseapp.com",
    projectId: "anep-s-booster",
    storageBucket: "anep-s-booster.firebasestorage.app",
    messagingSenderId: "349506408528",
    appId: "1:349506408528:web:a049a1097c55595212c155",
    databaseURL: "https://anep-s-booster-default-rtdb.asia-southeast1.firebasedatabase.app/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.writeLog = function(action){
    push(ref(db,"logs/"+window.deviceId),{
      action:action,
      ts:Date.now()
    }).then(()=>{
      console.log("Firebase Log OK:", action);
    }).catch(e=>{
      console.error("Firebase Log ERROR:",e);
    });
  };

  // ACTION HOOKS
  const f = window.feedPet;
  const p = window.petPet;
  const k = window.sendKiss;

  window.feedPet = function(...a){
    f(...a);
    writeLog("feedPet");
  };

  window.petPet = function(...a){
    p(...a);
    writeLog("petPet");
  };

  window.sendKiss = function(...a){
    k(...a);
    writeLog("sendKiss");
  };

</script>

</body>
</html>
