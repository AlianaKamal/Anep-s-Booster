<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Booster</title>

    <style>
      :root{
        --pink:#ff69b4;
        --hotpink:#ff1493;
        --bg:#ffe4e1;
        --card-bg:#ffffff;
        --muted:#f0f0f0;
      }
      html,body{height:100%}
      body {
          background-color: var(--bg);
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          margin: 0;
          font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          text-align: center;
          overflow: auto;
      }

      /* Card */
      .container {
          background-color: var(--card-bg);
          padding: 28px 32px;
          border-radius: 18px;
          box-shadow: 0 12px 30px rgba(0,0,0,0.08);
          width: 720px;
          max-width: calc(100% - 40px);
          display: flex;
          gap: 28px;
          align-items: center;
          justify-content: center;
          flex-wrap: nowrap;
      }

      /* Left column: avatar + progress + buttons (centered column) */
      .left-col {
          width: 560px;
          display:flex;
          flex-direction:column;
          align-items:center;
          gap:14px;
      }
      h1{font-size:1.6rem;margin:0 0 4px;font-weight:700;color:#111}
      .avatar-wrap{
          width:170px;height:170px;border-radius:50%;
          padding:6px;border:6px solid var(--pink);
          display:flex;align-items:center;justify-content:center;
          background:linear-gradient(180deg, #fff, #fff);
          box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      }

      /* Pet image */
      #pet-display {
          width:150px;
          height:150px;
          border-radius:50%;
          object-fit:cover;
          transition: transform .25s, border-color .25s, opacity .3s;
      }

      /* progress */
      .meter{ width:100%; background:var(--muted); border-radius:12px; padding:4px; box-sizing:border-box; }
      .progress{
          height:26px; width: 50%; /* JS will update */
          background:linear-gradient(90deg,var(--hotpink),var(--pink)); border-radius:10px;
          display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
          transition: width 0.45s ease-in-out; font-size:0.92rem;
      }
      #status-message{ color:var(--pink); font-weight:600; margin-top:6px; min-height:1.2em; }

      /* main buttons row */
      .buttons{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:4px; }
      .buttons button{
          padding:10px 16px; border-radius:10px; border:none; background:var(--pink); color:#fff;
          font-weight:600; cursor:pointer; box-shadow: 0 6px 12px rgba(255,105,180,0.12);
      }
      .action-big { width:160px; }

      /* reward visuals */
      .reward-item {
        position:absolute; pointer-events:none; width:64px; height:64px; transform:translate(-50%,-50%) scale(0.1);
        transition: transform 450ms cubic-bezier(.2,.9,.2,1), opacity 350ms;
        opacity:0; z-index:9998;
        filter: drop-shadow(0 6px 12px rgba(0,0,0,0.18));
      }

      @media (max-width:780px){
          .container{ flex-direction:column; width:94%; padding:20px; gap:16px;}
          .left-col{ width:100%}
      }
    </style>
</head>
<body>

  <div class="container">
    <div class="left-col">
      <h1>Hi B (B for Brader)</h1>

      <div class="avatar-wrap" aria-hidden="true">
        <img id="pet-display" src="ratna_normal.png" alt="Gambar Pet Maya">
      </div>

      <div class="meter" aria-hidden="true" style="width:100%;">
        <div id="health-bar" class="progress">Kesihatan</div>
      </div>

      <div id="status-message">Hai Anep!</div>

      <div class="buttons" role="group" aria-label="Kawalan pet">
        <button onclick="feedPet()">Beri Makan üçî</button>
        <button onclick="petPet()">Pujuk ü§ó</button>
        <button onclick="sendKiss()" class="action-big">Send Kiss üòò</button>
      </div>
    </div>
  </div>

  <!-- confetti canvas -->
  <canvas id="confettiCanvas" style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></canvas>

  <!-- ===== Skrip Asal (TIDAK DIUBAH) ===== -->
<script>
    const petDisplay = document.getElementById('pet-display');
    const statusMessage = document.getElementById('status-message');
    const healthBar = document.getElementById('health-bar');

    // Status awal (skala 0 hingga 100)
    let health = 100;
    // Fungsi utiliti untuk tukar gambar
    function changeImage(imageSrc) {
        petDisplay.src = imageSrc;
    }

    // Fungsi apabila memberi makan
    function feedPet() {
        health = Math.min(100, health + 15);
        updatePetStatus("Yummy! Masyeh Anep! üòã");
        changeImage('ratna_makan.png'); // Tukar gambar makan
        // Animasi melantun kecil
        petDisplay.style.transform = 'translateY(-10px)'; 
        setTimeout(() => { petDisplay.style.transform = 'translateY(0px)'; }, 300);
    }

    // Fungsi apabila membelai
    function petPet() {
        health = Math.min(100, health + 10);
        updatePetStatus("Ocey, Tak Majuk Dah! ü•∞");
        changeImage('ratna_gembira.png'); // Tukar gambar gembira
        // Animasi bergoncang (pusing)
        petDisplay.style.transform = 'rotate(-5deg)'; 
        setTimeout(() => {
            petDisplay.style.transform = 'rotate(5deg)';
            setTimeout(() => { petDisplay.style.transform = 'rotate(0deg)'; }, 100);
        }, 100);
    }

    // Fungsi baharu: Hantar Ciuman
    function sendKiss() {
        health = Math.min(100, health + 5); // Ciuman pun baik untuk kesihatan!
        updatePetStatus("Muaahh! üíñ");
        changeImage('ratna_kiss.png'); // Tukar gambar cium
        // Animasi skala (zoom in/out)
        petDisplay.style.transform = 'scale(1.2)';
        petDisplay.style.borderColor = '#FF0000'; // Tukar border kepada merah cinta

        setTimeout(() => {
            petDisplay.style.transform = 'scale(1)';
            petDisplay.style.borderColor = '#ff69b4'; // Kembali ke warna asal
        }, 500);
    }

    // Fungsi untuk kemas kini paparan dan mesej
    function updatePetStatus(message) {
        statusMessage.textContent = message;
        healthBar.style.width = `${health}%`;
        healthBar.textContent = `${health}% Mood Titew`;
        
        if (health < 30) {
            statusMessage.style.color = 'red';
        } else {
            statusMessage.style.color = '#ff69b4';
        }
    } 

    // Kesihatan berkurangan secara beransur-ansur dari masa ke masa
    setInterval(() => {
        health = Math.max(0, health - 2);
        
        if (health === 0) {
            updatePetStatus("Oh No! Anep Dah Tak Sayang Saya! üíÄ");
            changeImage('ratna_normal.png'); // Kembali ke gambar biasa bila tiada interaksi
        } else {
            updatePetStatus("Nak attention pwiss! ü•∫"); 
            if (!petDisplay.src.includes('ratna_normal.png') && 
                !petDisplay.src.includes('ratna_makan.png') && 
                !petDisplay.src.includes('ratna_gembira.png') && 
                !petDisplay.src.includes('ratna_kiss.png')) {
                     changeImage('ratna_normal.png');
            }
        }

    }, 3000); // Setiap 3 saat

    // Muatkan status awal
    updatePetStatus("Hai Anep! Jaga Titew baik-baik ya! üòä");
    changeImage('ratna_normal.png');

</script>

  <!-- ===== Integration Block (ADDED) ‚Äî localStorage, confetti, audio, combo/XP, legacy petState support ===== -->
  <script>
/* Integration layer ‚Äî keeps audio + save/XP/confetti and now includes legacy petState support plus lastInteraction */
if (typeof window.feedPet === 'function' && typeof window.petPet === 'function' && typeof window.sendKiss === 'function') {

  const STORAGE_KEY = 'petState_v2';
  const LEGACY_KEY  = 'petState';
  const state = {
    health: (typeof health === 'number') ? health : 100,
    xp: Number(localStorage.getItem('pet_xp') || 0),
    level: Number(localStorage.getItem('pet_level') || 1),
    lastClaim: localStorage.getItem('pet_lastClaim') || null,
    lastInteraction: localStorage.getItem('pet_lastInteraction') || null,
    mute: (localStorage.getItem('pet_mute') === '1'),
  };
  if (typeof window.health === 'number') state.health = window.health;

  // UI refs (safe guards: some extras removed)
  const levelBadge = document.getElementById('levelBadge'); // may be null

  const REWARDS = [
    { id:'candy', name:'Candy', health: 12, xp: 12, icon: 'üç¨' },
    { id:'toy', name:'Toy', health: 20, xp: 18, icon: 'üß∏' },
    { id:'drink', name:'Drink', health: 10, xp: 10, icon: 'ü•§' }
  ];

  // save/load helpers
  function saveState_v2(){
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ health: state.health, xp: state.xp, level: state.level, lastClaim: state.lastClaim, lastInteraction: state.lastInteraction }));
      localStorage.setItem('pet_xp', String(state.xp));
      localStorage.setItem('pet_level', String(state.level));
      localStorage.setItem('pet_mute', state.mute ? '1' : '0');
      localStorage.setItem('pet_lastInteraction', state.lastInteraction || '');
    } catch(e){
      console.warn('saveState_v2 failed', e);
    }
  }

  function loadStored_v2(){
    try {
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      if (typeof saved.health === 'number') {
        state.health = saved.health;
        if (typeof window.health !== 'undefined') window.health = state.health;
        const hb = document.getElementById('health-bar');
        if (hb) { hb.style.width = `${state.health}%`; hb.textContent = `${state.health}% Mood Titew`; }
      }
      if (typeof saved.lastInteraction === 'string' && saved.lastInteraction) state.lastInteraction = saved.lastInteraction;
      if (levelBadge && typeof saved.level === 'number') levelBadge.textContent = `Lvl ${saved.level}`;
    } catch(e){
      console.warn('loadStored_v2 failed', e);
    }
  }

  // initial load v2
  loadStored_v2();

  /* --- LEGACY petState compatibility + lastImage/status persistence --- */
  function getFileNameFromSrc(src){
    try {
      if(!src) return '';
      return src.split('/').pop().split('?')[0].split('#')[0];
    } catch(e){ return src || ''; }
  }

  try {
    const legacy = JSON.parse(localStorage.getItem(LEGACY_KEY) || '{}');
    if (legacy && typeof legacy === 'object') {
      if (legacy.health !== undefined && !isNaN(Number(legacy.health))) {
        state.health = Number(legacy.health);
        if (typeof window.health !== 'undefined') window.health = state.health;
        const hb = document.getElementById('health-bar');
        if (hb) { hb.style.width = `${state.health}%`; hb.textContent = `${state.health}% Mood Titew`; }
      }

      if (legacy.lastImage) {
        // attempt to restore last image (filename or path)
        try {
          if (typeof changeImage === 'function') {
            // If legacy stored only filename and images in same folder, this will work.
            changeImage(legacy.lastImage);
          }
        } catch(e){}
      }

      if (legacy.status) {
        try {
          if (typeof updatePetStatus === 'function') {
            updatePetStatus(legacy.status);
          } else {
            const sm = document.getElementById('status-message');
            if (sm) sm.textContent = legacy.status;
          }
        } catch(e){}
      }
    }
  } catch(e){ console.warn('failed to parse legacy petState', e); }

  /* --- Enhance saveState: call v2 saver and also write legacy petState key (lastImage/status) --- */
  function writeLegacyPetState(){
    try {
      const payload = {
        health: state.health,
        lastImage: (typeof petDisplay !== 'undefined' && petDisplay.src) ? getFileNameFromSrc(petDisplay.src) : '',
        status: (typeof statusMessage !== 'undefined' && statusMessage.textContent) ? statusMessage.textContent : '',
        lastSaved: new Date().toISOString()
      };
      localStorage.setItem(LEGACY_KEY, JSON.stringify(payload));
    } catch(e){
      console.warn('writing legacy petState failed', e);
    }
  }

  function saveState(){
    // primary v2 save
    saveState_v2();
    // write legacy-friendly object too
    writeLegacyPetState();
  }

  // AUDIO SETUP ‚Äî keep using your existing file names (change paths if in folder)
  const sFeed = new Audio('sfxeat.mp3.wav');   // feed
  const sPet  = new Audio('sfxpurr.mp3.wav');  // pet (human-like)
  const sKiss = new Audio('sfxkiss.mp3.wav');  // kiss

  [sFeed, sPet, sKiss].forEach(a => { a.preload = 'auto'; a.volume = 0.9; });

  function playSound(audio) { if (state.mute) return; try { audio.currentTime = 0; audio.play().catch(()=>{}); } catch(e){} }

  // Confetti canvas
  const confCanvas = document.getElementById('confettiCanvas');
  const cctx = confCanvas.getContext ? confCanvas.getContext('2d') : null;
  function resizeCanvas(){ if(!cctx) return; confCanvas.width = window.innerWidth; confCanvas.height = window.innerHeight; }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();

  function burstConfetti(x = window.innerWidth/2, y = window.innerHeight/3){
    if(!cctx) return;
    const parts = [], colors=['#ff69b4','#ff1493','#ffd700','#f06292'];
    for(let i=0;i<50;i++){
      parts.push({ x, y, vx:(Math.random()-0.5)*8, vy:-Math.random()*8-2, r:3+Math.random()*6, c: colors[Math.floor(Math.random()*colors.length)], life:70+Math.floor(Math.random()*30) });
    }
    let t=0;
    const anim = setInterval(()=> {
      cctx.clearRect(0,0,confCanvas.width,confCanvas.height);
      parts.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.vy+=0.25; p.life--;
        cctx.fillStyle=p.c; cctx.beginPath(); cctx.ellipse(p.x,p.y,p.r,p.r*0.8,0,0,Math.PI*2); cctx.fill();
      });
      t++; if(t>90){ clearInterval(anim); cctx.clearRect(0,0,confCanvas.width,confCanvas.height); }
    },16);
  }

  // level/xp
  function xpNeededFor(l){ return l*50; }
  function addXP(n){
    state.xp += n;
    while (state.xp >= xpNeededFor(state.level)){
      state.xp -= xpNeededFor(state.level);
      state.level++;
      burstConfetti();
      if (typeof window.updatePetStatus === 'function') window.updatePetStatus(`Level up! Now level ${state.level} üéâ`);
    }
    saveState();
    if (levelBadge) levelBadge.textContent = `Lvl ${state.level}`;
  }

  // combo tap for feed
  let comboTaps = 0, comboTimer = null;
  function registerComboTap(){
    comboTaps++;
    if (comboTimer) clearTimeout(comboTimer);
    comboTimer = setTimeout(()=>{
      if (comboTaps >= 5){
        state.health = Math.min(100, state.health + 40);
        if (typeof window.health !== 'undefined') window.health = state.health;
        if (typeof window.updatePetStatus === 'function') window.updatePetStatus('Combo! +40 üéØ');
        burstConfetti(); addXP(30);
      } else if (comboTaps >= 3){
        state.health = Math.min(100, state.health + 20);
        if (typeof window.health !== 'undefined') window.health = state.health;
        if (typeof window.updatePetStatus === 'function') window.updatePetStatus('Nice combo! +20');
        addXP(15);
      } else {
        addXP(5);
      }
      const hb = document.getElementById('health-bar');
      if (hb) { hb.style.width = `${state.health}%`; hb.textContent = `${state.health}% Mood Titew`; }
      saveState(); comboTaps=0; comboTimer=null;
    }, 2500);
  }

  // reward visual
  function showRewardVisual(reward){
    const container = document.createElement('div');
    container.className = 'reward-item';
    container.style.left = (window.innerWidth/2 + 40) + 'px';
    container.style.top = (window.innerHeight/2 - 40) + 'px';
    container.style.fontSize = '48px';
    container.style.display = 'flex';
    container.style.alignItems = 'center';
    container.style.justifyContent = 'center';
    container.textContent = reward.icon || reward.name;
    document.body.appendChild(container);
    requestAnimationFrame(()=> {
      container.style.opacity = '1';
      container.style.transform = 'translate(-50%,-120%) scale(1)';
    });
    setTimeout(()=> {
      container.style.opacity = '0';
      container.style.transform = 'translate(-50%,-200%) scale(0.6)';
      setTimeout(()=> container.remove(), 600);
    }, 900);
  }

  // preserve originals and wrap (no edits inside original functions)
  const origFeed = window.feedPet.bind(window);
  const origPet  = window.petPet.bind(window);
  const origKiss = window.sendKiss.bind(window);

  window.feedPet = function(...args){
    origFeed(...args);
    // update state & save
    if (typeof window.health === 'number') state.health = window.health;
    state.lastInteraction = new Date().toISOString();
    playSound(sFeed);
    burstConfetti();
    addXP(10);
    saveState();
    registerComboTap();
  };

  window.petPet = function(...args){
    origPet(...args);
    if (typeof window.health === 'number') state.health = window.health;
    state.lastInteraction = new Date().toISOString();
    playSound(sPet);
    addXP(7);
    saveState();
  };

  window.sendKiss = function(...args){
    origKiss(...args);
    if (typeof window.health === 'number') state.health = window.health;
    state.lastInteraction = new Date().toISOString();
    playSound(sKiss);
    burstConfetti();
    addXP(4);
    saveState();
  };

  // setInterval auto-save (v2) as safeguard
  setInterval(saveState, 5000);
  window.addEventListener('beforeunload', saveState);

} else {
  console.warn('Integration skipped: original functions not found.');
}
  </script>

</body>
</html>
