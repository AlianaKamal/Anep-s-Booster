<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mood Booster</title>

    <style>
      :root{
        --pink:#ff69b4;
        --hotpink:#ff1493;
        --bg:#ffe4e1;
        --card-bg:#ffffff;
        --muted:#f0f0f0;
        --text:#111;
      }
      [data-theme="dark"]{
        --bg:#1b1220;
        --card-bg:#241726;
        --muted:#2b1c2a;
        --pink:#ff9acb;
        --hotpink:#ff6ea6;
        --text:#f6eef6;
      }
      html,body{height:100%}
      body {
          background-color: var(--bg);
          color: var(--text);
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          margin: 0;
          font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          text-align: center;
          overflow: auto;
          transition: background-color .25s, color .25s;
      }

      /* Theme toggle (small) */
      #themeToggle {
        position: fixed;
        right: 12px;
        top: 12px;
        background: transparent;
        border: 2px solid rgba(255,255,255,0.12);
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        z-index: 99999;
        font-weight:700;
        backdrop-filter: blur(4px);
      }

      /* Card */
      .container {
          background-color: var(--card-bg);
          padding: 28px 32px;
          border-radius: 18px;
          box-shadow: 0 12px 30px rgba(0,0,0,0.08);
          width: 720px;
          max-width: calc(100% - 40px);
          display: flex;
          gap: 28px;
          align-items: center;
          justify-content: center;
          flex-wrap: nowrap;
          transition: background-color .25s, box-shadow .25s;
      }

      /* Left column: avatar + progress + buttons (centered column) */
      .left-col {
          width: 560px;
          display:flex;
          flex-direction:column;
          align-items:center;
          gap:14px;
      }
      h1{font-size:1.6rem;margin:0 0 4px;font-weight:700;color:var(--text)}
      .avatar-wrap{
          width:170px;height:170px;border-radius:50%;
          padding:6px;border:6px solid var(--pink);
          display:flex;align-items:center;justify-content:center;
          background:linear-gradient(180deg, transparent, rgba(0,0,0,0.03));
          box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      }

      /* Pet image */
      #pet-display {
          width:150px;
          height:150px;
          border-radius:50%;
          object-fit:cover;
          transition: transform .25s, border-color .25s, opacity .3s;
      }

      /* progress */
      .meter{ width:100%; background:var(--muted); border-radius:12px; padding:4px; box-sizing:border-box; }
      .progress{
          height:26px; width: 50%; /* JS will update */
          background:linear-gradient(90deg,var(--hotpink),var(--pink)); border-radius:10px;
          display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
          transition: width 0.45s ease-in-out; font-size:0.92rem;
      }
      #status-message{ color:var(--pink); font-weight:600; margin-top:6px; min-height:1.2em; }
      #last-interaction { font-size:12px; color: rgba(0,0,0,0.55); margin-top:6px; min-height:1.1em; }
      [data-theme="dark"] #last-interaction { color: rgba(255,255,255,0.6); }

      /* main buttons row */
      .buttons{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:4px; }
      .buttons button{
          padding:10px 16px; border-radius:10px; border:none; background:var(--pink); color:#fff;
          font-weight:600; cursor:pointer; box-shadow: 0 6px 12px rgba(255,105,180,0.12);
      }
      .action-big { width:160px; }

      /* reward visuals */
      .reward-item {
        position:absolute; pointer-events:none; width:64px; height:64px; transform:translate(-50%,-50%) scale(0.1);
        transition: transform 450ms cubic-bezier(.2,.9,.2,1), opacity 350ms;
        opacity:0; z-index:9998;
        filter: drop-shadow(0 6px 12px rgba(0,0,0,0.18));
      }

      @media (max-width:780px){
          .container{ flex-direction:column; width:94%; padding:20px; gap:16px;}
          .left-col{ width:100%}
      }
    </style>
</head>
<body>

<!-- PASTE AT VERY TOP OF index.html -->
<script>
  (function(){
    try {
      const TOKEN_KEY = 'mood_booster_auth_v1';
      const DEFAULT_EXPIRY_MS = 1000*60*60*24*7; // keep in sync with gate
      function isTokenValid(raw){
        if(!raw) return false;
        const parts = raw.split(':');
        if(parts[0] !== 'ok') return false;
        if(parts[2] === 'perm') return true; // permanent remember
        const ts = parseInt(parts[1]) || 0;
        return (Date.now() - ts) < DEFAULT_EXPIRY_MS;
      }
      const t = localStorage.getItem(TOKEN_KEY);
      if (!isTokenValid(t)){
        localStorage.removeItem(TOKEN_KEY);
        location.replace('gate.html');
      }
    } catch(e){
      location.replace('gate.html');
    }
  })();
</script>


  <!-- small theme toggle -->
  <button id="themeToggle" aria-label="Toggle theme">üåô</button>

  <div class="container">
    <div class="left-col">
      <h1>Hi B (B for Brader)</h1>

      <div class="avatar-wrap" aria-hidden="true">
        <img id="pet-display" src="ratna_normal.png" alt="Gambar Pet Maya">
      </div>

      <div class="meter" aria-hidden="true" style="width:100%;">
        <div id="health-bar" class="progress">Kesihatan</div>
      </div>

      <div id="status-message">Hai Anep!</div>
      <div id="last-interaction">Last: -</div>

      <div class="buttons" role="group" aria-label="Kawalan pet">
        <button onclick="feedPet()">Beri Makan üçî</button>
        <button onclick="petPet()">Pujuk ü§ó</button>
        <button onclick="sendKiss()" class="action-big">Send Kiss üòò</button>
      </div>
    </div>
  </div>

  <!-- confetti / particles canvas -->
  <canvas id="confettiCanvas" style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></canvas>

  <!-- ===== Skrip Asal (TIDAK DIUBAH) ===== -->
<script>
    const petDisplay = document.getElementById('pet-display');
    const statusMessage = document.getElementById('status-message');
    const healthBar = document.getElementById('health-bar');

    // Status awal (skala 0 hingga 100)
    let health = 100;
    // Fungsi utiliti untuk tukar gambar
    function changeImage(imageSrc) {
        petDisplay.src = imageSrc;
    }

    // Fungsi apabila memberi makan
    function feedPet() {
        health = Math.min(100, health + 15);
        updatePetStatus("Yummy! Masyeh Anep! üòã");
        changeImage('ratna_makan.png'); // Tukar gambar makan
        // Animasi melantun kecil
        petDisplay.style.transform = 'translateY(-10px)'; 
        setTimeout(() => { petDisplay.style.transform = 'translateY(0px)'; }, 300);
    }

    // Fungsi apabila membelai
    function petPet() {
        health = Math.min(100, health + 10);
        updatePetStatus("Ocey, Tak Majuk Dah! ü•∞");
        changeImage('ratna_gembira.png'); // Tukar gambar gembira
        // Animasi bergoncang (pusing)
        petDisplay.style.transform = 'rotate(-5deg)'; 
        setTimeout(() => {
            petDisplay.style.transform = 'rotate(5deg)';
            setTimeout(() => { petDisplay.style.transform = 'rotate(0deg)'; }, 100);
        }, 100);
    }

    // Fungsi baharu: Hantar Ciuman
    function sendKiss() {
        health = Math.min(100, health + 5); // Ciuman pun baik untuk kesihatan!
        updatePetStatus("Muaahh! üíñ");
        changeImage('ratna_kiss.png'); // Tukar gambar cium
        // Animasi skala (zoom in/out)
        petDisplay.style.transform = 'scale(1.2)';
        petDisplay.style.borderColor = '#FF0000'; // Tukar border kepada merah cinta

        setTimeout(() => {
            petDisplay.style.transform = 'scale(1)';
            petDisplay.style.borderColor = '#ff69b4'; // Kembali ke warna asal
        }, 500);
    }

    // Fungsi untuk kemas kini paparan dan mesej
    function updatePetStatus(message) {
        statusMessage.textContent = message;
        healthBar.style.width = `${health}%`;
        healthBar.textContent = `${health}% Mood Titew`;
        
        if (health < 30) {
            statusMessage.style.color = 'red';
        } else {
            statusMessage.style.color = '#ff69b4';
        }
    } 

    // Kesihatan berkurangan secara beransur-ansur dari masa ke masa
    setInterval(() => {
        health = Math.max(0, health - 2);
        
        if (health === 0) {
            updatePetStatus("Oh No! Anep Dah Tak Sayang Saya! üíÄ");
            changeImage('ratna_normal.png'); // Kembali ke gambar biasa bila tiada interaksi
        } else {
            updatePetStatus("Nak attention pwiss! ü•∫"); 
            if (!petDisplay.src.includes('ratna_normal.png') && 
                !petDisplay.src.includes('ratna_makan.png') && 
                !petDisplay.src.includes('ratna_gembira.png') && 
                !petDisplay.src.includes('ratna_kiss.png')) {
                     changeImage('ratna_normal.png');
            }
        }

    }, 3000); // Setiap 3 saat

    // Muatkan status awal
    updatePetStatus("Hai Anep! Jaga Titew baik-baik ya! üòä");
    changeImage('ratna_normal.png');

</script>

  <!-- Integration Block (UPDATED + Particle Effects + write pet_lastAction) -->
  <script>
/* Integration layer ‚Äî persistence, audio SFX, and 3 particle effects.
   Also writes pet_lastAction to localStorage on every user action (source:'index'). */
(function(){
  if (!(typeof window.feedPet === 'function' && typeof window.petPet === 'function' && typeof window.sendKiss === 'function')) {
    console.warn('Integration skipped: original functions not found.');
    return;
  }

  const STORAGE_KEY = 'petState_v2';
  const lastEl = document.getElementById('last-interaction');
  const themeBtn = document.getElementById('themeToggle');
  const confCanvas = document.getElementById('confettiCanvas');
  const cctx = confCanvas && confCanvas.getContext ? confCanvas.getContext('2d') : null;

  // Use the actual global `health` variable if present; fallback to 100
  const state = {
    health: (typeof health === 'number') ? health : 100,
    lastInteraction: localStorage.getItem('pet_lastInteraction') || null,
    theme: localStorage.getItem('pet_theme') || 'light'
  };

  // AUDIO SETUP ‚Äî uses your existing filenames (place files in same folder or adjust paths)
  const sFeed = new Audio('sfxeat.mp3.wav');   // feed
  const sPet  = new Audio('sfxpurr.mp3.wav');  // pet / cute human-like
  const sKiss = new Audio('sfxkiss.mp3.wav');  // kiss

  [sFeed, sPet, sKiss].forEach(a => { a.preload = 'auto'; a.volume = 0.9; });

  function playSFX(audio){
    try {
      audio.currentTime = 0;
      audio.play().catch(()=>{});
    } catch(e){}
  }

  // Resize canvas properly
  function resizeCanvas(){
    if(!cctx || !confCanvas) return;
    confCanvas.width = window.innerWidth;
    confCanvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  // Apply theme
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t === 'dark' ? 'dark' : 'light');
    if (themeBtn) themeBtn.textContent = (t === 'dark') ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('pet_theme', t);
    state.theme = t;
  }
  applyTheme(state.theme);

  // Save minimal state (always read from real `health` variable)
  function saveState(){
    try {
      if (typeof health === 'number') state.health = health;
      const payload = { health: state.health, lastInteraction: state.lastInteraction, theme: state.theme };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      localStorage.setItem('pet_lastInteraction', state.lastInteraction || '');
    } catch(e) {
      console.warn('saveState error', e);
    }
  }

  // Load saved state and apply to real `health`
  (function loadStored(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw || '{}');
      if (typeof parsed.health === 'number') {
        state.health = parsed.health;
        try { health = state.health; } catch(e){}
        try { window.health = state.health; } catch(e){}
        const hb = document.getElementById('health-bar');
        if (hb) { hb.style.width = `${state.health}%`; hb.textContent = `${state.health}% Mood Titew`; }
      }
      if (parsed.lastInteraction) {
        state.lastInteraction = parsed.lastInteraction;
        if (lastEl) lastEl.textContent = 'Last: ' + new Date(parsed.lastInteraction).toLocaleString();
      } else {
        if (lastEl) lastEl.textContent = 'Last: -';
      }
      if (parsed.theme) applyTheme(parsed.theme);
    } catch(e){
      console.warn('loadStored error', e);
    }
  })();

  // Update lastInteraction helper
  function updateLastInteraction() {
    state.lastInteraction = new Date().toISOString();
    if (lastEl) lastEl.textContent = 'Last: ' + new Date(state.lastInteraction).toLocaleString();
    saveState();
  }

  // ----------------------------
  // Particle / effect functions
  // ----------------------------
  function heartBurst(x = window.innerWidth/2, y = window.innerHeight/3){
    if (!cctx) return;
    const hearts = [];
    const colors = ['#ff4f8b', '#ff8bb3', '#ff6fa1', '#ff2d6f'];
    for (let i = 0; i < 18; i++) {
      hearts.push({
        x, y,
        vx: (Math.random() - 0.5) * 6,
        vy: -Math.random() * 6 - 2,
        size: 8 + Math.random() * 14,
        color: colors[Math.floor(Math.random() * colors.length)],
        life: 50 + Math.floor(Math.random() * 30),
        rot: Math.random() * Math.PI * 2,
        rotSpeed: (Math.random()-0.5)*0.08
      });
    }

    let t = 0;
    const anim = setInterval(() => {
      cctx.clearRect(0,0,confCanvas.width,confCanvas.height);
      hearts.forEach(h => {
        h.x += h.vx;
        h.y += h.vy;
        h.vy += 0.18;
        h.rot += h.rotSpeed;
        h.life--;
        const s = h.size;
        cctx.save();
        cctx.translate(h.x, h.y);
        cctx.rotate(h.rot);
        cctx.fillStyle = h.color;
        cctx.beginPath();
        cctx.moveTo(0, -s*0.6);
        cctx.bezierCurveTo(-s, -s*1.3, -s*1.2, s*0.2, 0, s);
        cctx.bezierCurveTo(s*1.2, s*0.2, s, -s*1.3, 0, -s*0.6);
        cctx.closePath();
        cctx.fill();
        cctx.restore();
      });
      t++;
      if (hearts.every(h => h.life <= 0) || t > 120) {
        clearInterval(anim);
        cctx.clearRect(0,0,confCanvas.width,confCanvas.height);
      }
    }, 16);
  }

  function foodBurst(x = window.innerWidth/2, y = window.innerHeight/3){
    if (!cctx) return;
    const foods = ["üçî", "üçü", "üçï"];
    const parts = [];
    for (let i = 0; i < 14; i++) {
      parts.push({
        x, y,
        vx: (Math.random() - 0.5) * 8,
        vy: -Math.random() * 6 - 2,
        size: 20 + Math.random() * 22,
        emoji: foods[Math.floor(Math.random() * foods.length)],
        life: 40 + Math.random() * 30,
        rot: (Math.random()-0.5)*0.6
      });
    }
    let t = 0;
    const anim = setInterval(() => {
      cctx.clearRect(0,0,confCanvas.width,confCanvas.height);
      parts.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.25;
        p.rot += 0.02;
        p.life--;
        cctx.save();
        cctx.translate(p.x, p.y);
        cctx.rotate(p.rot);
        cctx.font = `${p.size}px serif`;
        cctx.textAlign = 'center';
        cctx.textBaseline = 'middle';
        cctx.fillText(p.emoji, 0, 0);
        cctx.restore();
      });
      t++;
      if (parts.every(p => p.life <= 0) || t > 120) {
        clearInterval(anim);
        cctx.clearRect(0,0,confCanvas.width,confCanvas.height);
      }
    }, 16);
  }

  function sparkleBurst(x = window.innerWidth/2, y = window.innerHeight/3){
    if (!cctx) return;
    const parts = [];
    const colors = ['#ffffff', '#ffe6f2', '#ff8ccd'];
    for (let i = 0; i < 28; i++) {
      parts.push({
        x, y,
        vx: (Math.random() - 0.5) * 5,
        vy: (Math.random() - 0.5) * 5 - 1,
        size: 1 + Math.random() * 5,
        color: colors[Math.floor(Math.random() * colors.length)],
        life: 30 + Math.random() * 30,
        glow: 0.6 + Math.random()*0.8
      });
    }
    let t = 0;
    const anim = setInterval(() => {
      cctx.clearRect(0,0,confCanvas.width,confCanvas.height);
      parts.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.03;
        p.life--;
        const g = cctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size*3);
        g.addColorStop(0, p.color);
        g.addColorStop(0.6, p.color);
        g.addColorStop(1, 'rgba(0,0,0,0)');
        cctx.globalAlpha = Math.max(0, p.life/50);
        cctx.fillStyle = g;
        cctx.beginPath();
        cctx.arc(p.x, p.y, p.size*2.2, 0, Math.PI*2);
        cctx.fill();
        cctx.globalAlpha = 1;
      });
      t++;
      if (parts.every(p => p.life <= 0) || t > 120) {
        clearInterval(anim);
        cctx.clearRect(0,0,confCanvas.width,confCanvas.height);
      }
    }, 16);
  }

  // ----------------------------
  // Preserve originals and wrap them (no changes inside original functions)
  // ----------------------------
  const origFeed = window.feedPet.bind(window);
  const origPet  = window.petPet.bind(window);
  const origKiss = window.sendKiss.bind(window);

  window.feedPet = function(...args){
    origFeed(...args);
    // sync from real health variable to state
    if (typeof health === 'number') state.health = health;
    // play sfx
    playSFX(sFeed);
    // show food burst around avatar center
    const rect = petDisplay.getBoundingClientRect();
    foodBurst(rect.left + rect.width/2, rect.top + rect.height/2);

    // write minimal entry so dev.html can pick it up (source: 'index')
    try {
      localStorage.setItem('pet_lastAction', JSON.stringify({
        source: 'index',
        action: 'feedPet',
        amount: 15,
        ts: new Date().toISOString()
      }));
    } catch(e){}

    updateLastInteraction();
    saveState();
  };

  window.petPet = function(...args){
    origPet(...args);
    if (typeof health === 'number') state.health = health;
    playSFX(sPet);
    const rect = petDisplay.getBoundingClientRect();
    sparkleBurst(rect.left + rect.width/2, rect.top + rect.height/2);

    try {
      localStorage.setItem('pet_lastAction', JSON.stringify({
        source: 'index',
        action: 'petPet',
        amount: 10,
        ts: new Date().toISOString()
      }));
    } catch(e){}

    updateLastInteraction();
    saveState();
  };

  window.sendKiss = function(...args){
    origKiss(...args);
    if (typeof health === 'number') state.health = health;
    playSFX(sKiss);
    const rect = petDisplay.getBoundingClientRect();
    heartBurst(rect.left + rect.width/2, rect.top + rect.height/2 - 10);

    try {
      localStorage.setItem('pet_lastAction', JSON.stringify({
        source: 'index',
        action: 'sendKiss',
        amount: 5,
        ts: new Date().toISOString()
      }));
    } catch(e){}

    updateLastInteraction();
    saveState();
  };

  // theme toggle button event
  if (themeBtn) {
    themeBtn.addEventListener('click', ()=> {
      const next = (state.theme === 'dark') ? 'light' : 'dark';
      applyTheme(next);
      saveState();
    });
  }

  // ensure save periodically as fallback
  setInterval(saveState, 5000);
  window.addEventListener('beforeunload', saveState);

  // initial save to ensure storage keys exist
  saveState();

})();
  </script>

    <!-- START: On-screen console (paste before </body>) -->
<style>
  #onScreenConsole {
    position: fixed;
    right: 12px;
    bottom: 12px;
    width: 320px;
    max-height: 42vh;
    background: rgba(255,255,255,0.95);
    border-radius: 10px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    overflow:auto;
    font-family: system-ui, Arial;
    font-size: 12px;
    color: #222;
    border: 1px solid #ffdfe9;
    z-index: 99999;
  }
  #onScreenConsole header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #fde8f2;background:linear-gradient(180deg,#fff,#fff7fb);border-top-left-radius:10px;border-top-right-radius:10px}
  #onScreenConsole .body{padding:8px; white-space:pre-wrap}
  #onScreenConsole .btn{background:#ff69b4;color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;font-weight:700}
  #onScreenConsole .small{font-size:11px;color:#7a3b51}
</style>

<div id="onScreenConsole" aria-hidden="false">
  <header>
    <div style="font-weight:700">On-screen Console</div>
    <div>
      <button id="oscToggle" class="btn" title="Toggle">Hide</button>
    </div>
  </header>
  <div class="body" id="oscBody" aria-live="polite">
    (console kosong)
  </div>
</div>

<script>
(function(){
  const K = 'osc_lines_v1';
  const out = document.getElementById('oscBody');
  const toggle = document.getElementById('oscToggle');
  let visible = true;

  function persist(lines){
    try{ localStorage.setItem(K, JSON.stringify(lines.slice(-200))); }catch(e){}
  }
  function loadLines(){
    try{
      const raw = localStorage.getItem(K);
      return raw ? JSON.parse(raw) : [];
    }catch(e){ return []; }
  }
  let lines = loadLines();

  function render(){
    if (lines.length === 0) out.textContent = '(console kosong)';
    else out.innerHTML = lines.map(l => `<div style="margin-bottom:6px">${l}</div>`).join('');
    out.scrollTop = out.scrollHeight;
  }

  function pushLine(level, msg){
    const ts = new Date().toLocaleTimeString();
    const color = (level === 'error') ? '#c0392b' : (level === 'warn' ? '#b45324' : '#3d155f');
    const safe = String(msg).replace(/&/g,'&amp;').replace(/</g,'&lt;');
    lines.unshift(`<span style="color:${color};font-weight:700">${ts}</span> ‚Äî <span class="small">${safe}</span>`);
    persist(lines);
    render();
  }

  // wrap console
  ['log','info','warn','error'].forEach(fn=>{
    const orig = console[fn].bind(console);
    console[fn] = function(...args){
      try{ pushLine(fn, args.map(a=> (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ')); }catch(e){}
      orig(...args);
    };
  });

  // expose a small helper so you can call: window.oscLog('hello')
  window.oscLog = function(...a){ console.log(...a); };

  // toggle UI
  toggle.addEventListener('click', ()=>{
    visible = !visible;
    document.getElementById('onScreenConsole').style.display = visible ? 'block' : 'none';
    toggle.textContent = visible ? 'Hide' : 'Show';
  });

  // initial render
  render();

  // convenience: show device id if stored
  const dev = localStorage.getItem('pet_deviceId') || 'tiada-deviceId';
  console.log('deviceId:', dev);
})();
</script>
<!-- END: On-screen console -->


</body>
</html>



