<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mood Booster ‚Äî Daily Fun (Testable)</title>
    <style>
        body{background:#ffe4e1;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;font-family:sans-serif;overflow:hidden}
        .container{background:#fff;padding:20px;border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,0.15);max-width:420px;width:92%;text-align:center}
        #pet-display{width:150px;height:150px;border-radius:50%;object-fit:cover;margin:8px auto;border:4px solid #ff69b4;transition:transform .3s,border-color .25s}
        .meter{width:100%;background:#f0f0f0;border-radius:6px;margin:10px 0}
        .progress{height:26px;width:50%;background:#ff1493;border-radius:6px;line-height:26px;color:#fff;font-weight:700;transition:width .45s}
        .buttons{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px}
        button{padding:10px 12px;background:#ff69b4;color:#fff;border:none;border-radius:8px;cursor:pointer}
        #dailyBtn{background:linear-gradient(90deg,#ff69b4,#ff1493);position:relative}
        #dailyBtn.pulse{animation:pulse 1.8s infinite}
        @keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,20,147,.18)}70%{transform:scale(1.03);box-shadow:0 0 0 8px rgba(255,20,147,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,20,147,0)}}
        #rewardPopup{position:fixed;left:50%;top:24%;transform:translate(-50%,-50%) scale(.8);background:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.2);opacity:0;pointer-events:none;transition:transform .3s,opacity .25s;z-index:2000;display:flex;gap:10px;align-items:center}
        #rewardPopup.show{transform:translate(-50%,-50%) scale(1);opacity:1;pointer-events:auto}
        #confettiCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1500}
        .small{font-size:.85rem;color:#666;margin-top:6px}
        #testControls{margin-top:8px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
        .muted{background:#ddd;color:#444}
    </style>
</head>
<body>
    <div class="container">
        <h1>Hi B (B for Brader)</h1>
        <img id="pet-display" src="ratna_normal.png" alt="Pet">
        <div class="meter"><div id="health-bar" class="progress">Kesihatan</div></div>
        <div id="status-message">Hai Anep!</div>
        <div id="last-interaction" class="small">Last interaction: ‚Äî</div>
        <div id="streak-display" class="small">Streak: 0 hari üî•</div>

        <div class="buttons">
            <button onclick="feedPet()">Beri Makan üçî</button>
            <button onclick="petPet()">Pujuk ü§ó</button>
            <button onclick="sendKiss()">Send Kiss üòò</button>
            <button id="dailyBtn" class="pulse" onclick="claimDaily()">Daily Snack üéÅ</button>
        </div>

        <div id="testControls" class="small">
            <!-- Butang ujian: terus tuntut tanpa semak tarikh -->
            <button id="forceClaimBtn" style="background:#39a0ff">Force Claim (Test)</button>
            <button id="resetLastClaim" class="muted">Reset Last Claim</button>
            <button id="clearAll" class="muted">Clear State</button>
        </div>

        <div id="daily-note" class="small"></div>
    </div>

    <div id="rewardPopup" aria-hidden="true"><div style="font-size:1.4rem;color:#ff1493;font-weight:700">+20</div><div><div style="font-weight:700">Daily Snack!</div><div style="font-size:.9rem;color:#666">Streak: <span id="popup-streak">0</span> hari</div></div></div>
    <canvas id="confettiCanvas"></canvas>

    <audio id="sfxClaim" src="sfx/claim.mp3" preload="auto"></audio>
    <audio id="sfxPop" src="sfx/pop.mp3" preload="auto"></audio>

<script>
/* ----- kept app state ----- */
const petDisplay = document.getElementById('pet-display');
const statusMessage = document.getElementById('status-message');
const healthBar = document.getElementById('health-bar');
const lastInteractionEl = document.getElementById('last-interaction');
const streakDisplay = document.getElementById('streak-display');
const dailyNote = document.getElementById('daily-note');
const dailyBtn = document.getElementById('dailyBtn');
const rewardPopup = document.getElementById('rewardPopup');
const popupStreak = document.getElementById('popup-streak');

const LAST_CLAIM_KEY = 'pet_lastClaimDate';
const STREAK_KEY = 'pet_streakCount';

let health = 100;
let lastInteraction = null;
let soundEnabled = true;

const sfxClaim = document.getElementById('sfxClaim');
const sfxPop = document.getElementById('sfxPop');

/* ----- confetti minimal ----- */
const cc = document.getElementById('confettiCanvas');
const ctx = cc.getContext('2d');
function resize(){ cc.width = innerWidth; cc.height = innerHeight; } window.addEventListener('resize', resize); resize();
function burstConfetti(){
    const parts=[]; const cols=['#ff69b4','#ff1493','#ffd700','#ffd1e6'];
    for(let i=0;i<60;i++){ parts.push({x:innerWidth/2+(Math.random()-0.5)*160,y:innerHeight/3+(Math.random()-0.5)*60,vx:(Math.random()-0.5)*8,vy:-(2+Math.random()*6),r:3+Math.random()*6,color:cols[Math.floor(Math.random()*cols.length)],rot:Math.random()*360,vr:(Math.random()-0.5)*6});}
    let t=0; const anim=setInterval(()=>{ ctx.clearRect(0,0,cc.width,cc.height); for(const p of parts){ p.x+=p.vx;p.y+=p.vy;p.vy+=0.18;p.rot+=p.vr; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180); ctx.fillStyle=p.color; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r*1.6); ctx.restore(); } t++; if(t>80){ clearInterval(anim); ctx.clearRect(0,0,cc.width,cc.height);} },16);
}

/* ----- helpers ----- */
function getFileNameFromSrc(src){ try{ const parts=src.split('/'); return parts[parts.length-1].split('?')[0].split('#')[0]; }catch(e){ return src; } }
function changeImage(src){ petDisplay.src = src; }
function saveState(){ try{ const state={health,lastImage:getFileNameFromSrc(petDisplay.src||'ratna_normal.png'),status:statusMessage.textContent||'',lastInteraction:lastInteraction||null}; localStorage.setItem('petState', JSON.stringify(state)); }catch(e){} }
function loadState(){ try{ const raw=localStorage.getItem('petState'); if(!raw) return; const s=JSON.parse(raw); if(s){ if(typeof s.health==='number') health=Math.max(0,Math.min(100,s.health)); if(s.lastImage) changeImage(s.lastImage); if(s.status) statusMessage.textContent=s.status; if(s.lastInteraction) lastInteraction=s.lastInteraction; } }catch(e){} }

/* ----- streak ----- */
function getStreak(){ return Number(localStorage.getItem(STREAK_KEY) || 0); }
function setStreak(n){ localStorage.setItem(STREAK_KEY,String(n)); streakDisplay.textContent = `Streak: ${n} hari üî•`; popupStreak.textContent = n; }

/* ----- last interaction UI ----- */
function setLastInteractionNow(){ lastInteraction = new Date().toISOString(); }
function updateLastInteractionDisplay(){ if(!lastInteraction){ lastInteractionEl.textContent='Last interaction: ‚Äî'; return;} lastInteractionEl.textContent='Last interaction: '+ new Date(lastInteraction).toLocaleString(); }

/* ----- daily availability ----- */
function msUntilNextDayLocal(){ const now=new Date(); const tomorrow=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1); return tomorrow-now; }
let countdownTimer = null;
function startDailyCountdown(){ stopDailyCountdown(); function tick(){ const ms=msUntilNextDayLocal(); if(ms<=0){ dailyBtn.disabled=false; dailyBtn.classList.add('pulse'); dailyNote.textContent='Daily Snack tersedia. Tuntut sekali sehari.'; stopDailyCountdown(); return;} const sec=Math.floor(ms/1000); const h=Math.floor(sec/3600).toString().padStart(2,'0'); const m=Math.floor(sec%3600/60).toString().padStart(2,'0'); const s=Math.floor(sec%60).toString().padStart(2,'0'); dailyNote.textContent=`Daily sudah tuntut. Seterusnya dalam ${h}:${m}:${s}`; } tick(); countdownTimer=setInterval(tick,1000); }
function stopDailyCountdown(){ if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null;} }
function updateDailyAvailabilityUI(){ try{ const today=(new Date()).toISOString().slice(0,10); const lastClaim=localStorage.getItem(LAST_CLAIM_KEY); if(lastClaim===today){ dailyBtn.disabled=true; dailyBtn.classList.remove('pulse'); startDailyCountdown(); dailyNote.textContent='Daily Snack sudah dituntut hari ini.'; } else { dailyBtn.disabled=false; dailyBtn.classList.add('pulse'); dailyNote.textContent='Daily Snack tersedia. Tuntut sekali sehari.'; stopDailyCountdown(); } }catch(e){} }

/* ----- reward popup ----- */
function showRewardPopup(duration=1400){ rewardPopup.classList.add('show'); rewardPopup.setAttribute('aria-hidden','false'); if(soundEnabled) try{ sfxClaim.currentTime=0; sfxClaim.play().catch(()=>{}); }catch(e){} setTimeout(()=>{ rewardPopup.classList.remove('show'); rewardPopup.setAttribute('aria-hidden','true'); }, duration); }

/* ----- claimDaily (normal) ----- */
function claimDaily(){
    try{
        const today=(new Date()).toISOString().slice(0,10);
        const lastClaim=localStorage.getItem(LAST_CLAIM_KEY);
        if(lastClaim===today){ dailyNote.textContent='Anda sudah tuntut Daily Snack hari ini. Sila cuba esok.'; return; }
        // streak logic
        let streak=getStreak();
        if(lastClaim){
            const yesterday=new Date(); yesterday.setDate(yesterday.getDate()-1); const yStr=yesterday.toISOString().slice(0,10);
            if(lastClaim===yStr) streak = streak + 1; else streak = 1;
        } else { streak = 1; }
        setStreak(streak);
        // reward
        health = Math.min(100, health + 20);
        updatePetStatus('Daily Snack! +20 üéÅ');
        localStorage.setItem(LAST_CLAIM_KEY, today);
        setLastInteractionNow(); saveState(); updateLastInteractionDisplay();
        showRewardPopup(); burstConfetti(); if(soundEnabled) try{sfxPop.currentTime=0; sfxPop.play().catch(()=>{});}catch(e){}
        dailyBtn.disabled=true; dailyBtn.classList.remove('pulse'); startDailyCountdown();
        dailyNote.textContent='Berjaya tuntut! Datang lagi esok.';
    }catch(e){ console.warn(e); dailyNote.textContent='Tidak boleh tuntut sekarang.'; }
}

/* ----- FORCE CLAIM for testing (bypass date check) ----- */
function forceClaimForTest(){
    // This gives the same reward and UX but ignores lastClaim date. Useful for testing.
    try{
        let streak=getStreak();
        // increment streak for testing (does not check continuity)
        streak = streak + 1;
        setStreak(streak);
        health = Math.min(100, health + 20);
        updatePetStatus('Daily Snack (Test)! +20 üéÅ');
        setLastInteractionNow(); saveState(); updateLastInteractionDisplay();
        showRewardPopup(); burstConfetti();
        if(soundEnabled) try{sfxPop.currentTime=0; sfxPop.play().catch(()=>{});}catch(e){}
        // do not alter LAST_CLAIM_KEY so normal flow remains unchanged; but if you want to mark claimed, uncomment next line:
        // localStorage.setItem(LAST_CLAIM_KEY, (new Date()).toISOString().slice(0,10));
        dailyNote.textContent='Force claim selesai (test).';
    }catch(e){ console.warn(e); dailyNote.textContent='Force claim failed.'; }
}

/* ----- other interactions ----- */
function updatePetStatus(message){ statusMessage.textContent = message; healthBar.style.width = `${health}%`; healthBar.textContent = `${health}% Mood Titew`; if(health<30) statusMessage.style.color='red'; else statusMessage.style.color='#ff69b4'; saveState(); }
function feedPet(){ health = Math.min(100, health + 15); updatePetStatus("Yummy! Masyeh Anep! üòã"); changeImage('ratna_makan.png'); petDisplay.style.transform='translateY(-10px)'; setTimeout(()=>petDisplay.style.transform='translateY(0px)',300); setLastInteractionNow(); saveState(); updateLastInteractionDisplay(); }
function petPet(){ health = Math.min(100, health + 10); updatePetStatus("Ocey, Tak Majuk Dah! ü•∞"); changeImage('ratna_gembira.png'); petDisplay.style.transform='rotate(-5deg)'; setTimeout(()=>{ petDisplay.style.transform='rotate(5deg)'; setTimeout(()=>petDisplay.style.transform='rotate(0deg)',100); },100); setLastInteractionNow(); saveState(); updateLastInteractionDisplay(); }
function sendKiss(){ health = Math.min(100, health + 5); updatePetStatus("Muaahh! üíñ"); changeImage('ratna_kiss.png'); petDisplay.style.transform='scale(1.2)'; petDisplay.style.borderColor='#FF0000'; setTimeout(()=>{ petDisplay.style.transform='scale(1)'; petDisplay.style.borderColor='#ff69b4'; },500); setLastInteractionNow(); saveState(); updateLastInteractionDisplay(); }

/* ----- decay ----- */
setInterval(()=>{ health = Math.max(0, health - 2); if(health===0){ updatePetStatus("Oh No! Anep Dah Tak Sayang Saya! üíÄ"); changeImage('ratna_normal.png'); } else { updatePetStatus("Nak attention pwiss! ü•∫"); if(!petDisplay.src.includes('ratna_normal.png') && !petDisplay.src.includes('ratna_makan.png') && !petDisplay.src.includes('ratna_gembira.png') && !petDisplay.src.includes('ratna_kiss.png')) changeImage('ratna_normal.png'); } }, 3000);

/* ----- test control handlers ----- */
document.getElementById('forceClaimBtn').addEventListener('click', ()=>{ forceClaimForTest(); });
document.getElementById('resetLastClaim').addEventListener('click', ()=>{
    localStorage.removeItem(LAST_CLAIM_KEY);
    dailyNote.textContent = 'Last claim reset. Daily boleh dituntut sekarang.';
    updateDailyAvailabilityUI();
});
document.getElementById('clearAll').addEventListener('click', ()=>{
    if(confirm('Clear semua state (health, streak, last claim, saved state)?')) {
        localStorage.removeItem('petState');
        localStorage.removeItem(LAST_CLAIM_KEY);
        localStorage.removeItem(STREAK_KEY);
        location.reload();
    }
});

/* ----- init on load ----- */
loadState();
if(!localStorage.getItem(STREAK_KEY)) setStreak(0); else setStreak(getStreak());
updateLastInteractionDisplay();
updateDailyAvailabilityUI();
window.addEventListener('beforeunload', ()=> saveState());
</script>
</body>
</html>
